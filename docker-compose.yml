version: '3.8'

services:
#  zh-marketpulse-frontend:
#    container_name: zh-marketpulse-frontend
#    build:
#      context: ./frontend
#      dockerfile: Dockerfile
#    ports:
#      - "5173:80"
#    environment:
#      - VITE_API_BASE_URL=http://zh-marketpulse-collector:8001
#    depends_on:
#      - zh-marketpulse-collector
#    networks:
#      - zh-marketpulse-network
#    restart: unless-stopped
#    healthcheck:
#      test: ["CMD", "curl", "-f", "http://localhost:5173"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s

  zh-marketpulse-collector:
    container_name: zh-marketpulse-collector
    build:
      context: ./backend
      dockerfile: collector/Dockerfile
    ports:
      - "8001:8001"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://user:password@zh-marketpulse-db:5432/egx_db
      - PYTHONPATH=/app
    depends_on:
      - zh-marketpulse-db
    networks:
      - zh-marketpulse-network
    volumes:
      - ./backend/logs:/app/logs
      - ./backend/data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  zh-marketpulse-db:
    container_name: zh-marketpulse-db
    image: postgres:13
    environment:
      - POSTGRES_DB=egx_db
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
    ports:
      - "5432:5432"
    networks:
      - zh-marketpulse-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d egx_db"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:

networks:
  zh-marketpulse-network:
    driver: bridge